---
title: "10_Sankey_Diagram"
output: html_document
date: "2025-09-30"
---
```{r libraries}
library(ggsankey)
library(dplyr)
library(tidyr)
library(tibble)
library(microbiome)
library(ggplot2)
library(stringr)
```
https://r-charts.com/flow/sankey-diagram-ggplot2/
```{r data}
#Data
GMMs_corrected <- readRDS("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/GMMs_corrected.Rds")
GMMs_corrected<- subset_samples(GMMs_corrected, Group_cutoff_4 %in% c("R", "NR"))
GMMs_corrected<- subset_samples(GMMs_corrected, Timepoint %in% c("T0", "T2"))

ps_clr_corrected <- readRDS("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/ps_clr_corrected.Rds")
ps_clr_corrected<- subset_samples(ps_clr_corrected, Group_cutoff_4 %in% c("R", "NR"))
ps_clr_corrected<- subset_samples(ps_clr_corrected, Timepoint %in% c("T0", "T2"))

ARGs_ok_corrected <- readRDS("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/ARGs_ok_corrected.Rds")
ARGs_ok_corrected<- subset_samples(ARGs_ok_corrected, Group_cutoff_4 %in% c("R", "NR"))
ARGs_ok_corrected<- subset_samples(ARGs_ok_corrected, Timepoint %in% c("T0", "T2"))

metadata_ok<-data.frame(sample_data(GMMs_corrected))
# Identify columns with missing values (NA)
cols_with_missing <- colSums(is.na(metadata_ok)) > 0
# Subset the data frame to exclude columns with missing values
metadata <- metadata_ok[, !cols_with_missing]
metadata <- metadata[,c("SampleID","DmGenderSexID", "Group_cutoff_4", "Age", "Ammonia", "IL6", 
                        "Timepoint", "Study")]


#Create categorical for some variables
# Define the breaks and labels for the categories
breaks_Age <- c(-Inf, 50, 60, Inf)
labels_Age <- c("3<50", "250-60", "160>")

breaks_Amm <- c(-Inf, 16, 30, Inf)
labels_Amm <- c("3<16", "216-30", "130<")

breaks_IL6 <- c(-Inf, 1, 7, Inf)
labels_IL6 <- c("<1", "1-7", "7>")


# Create the new categorical variable IL6_ranges
metadata$Age_ranges <- cut(metadata_ok$Age, breaks = breaks_Age, labels = labels_Age, include.lowest = TRUE)
metadata$Amm_ranges <- cut(metadata_ok$Ammonia, breaks = breaks_Amm, labels = labels_Amm, include.lowest = TRUE)
metadata$IL6_ranges <- cut(metadata_ok$IL6, breaks = breaks_IL6, labels = labels_IL6, include.lowest = TRUE)

#Dominant families
library(microbiome)
dominant_families <-dominant(ps_clr_corrected, level = "Family")
sample_names <-sample_names(ps_clr_corrected)

combined_data <- data.frame(sample_names = sample_names, `Dominant_families` = dominant_families)

# Merge the data frames based on SampleID and sample_names
metadata <- merge(metadata, combined_data, by.x = "SampleID", by.y = "sample_names", all.x = TRUE)

#Dominant categories GMM
tax_GMM<-as.data.frame(tax_table(GMMs_corrected))
tax_GMM <- tax_GMM %>%
  mutate(
    Category = case_when(
      grepl("degradation", V2, ignore.case = TRUE) & grepl("tyrosine|phenylalanine|tryptophan|glutamate|alanine|valine|isoleucine|leucine|methionine|cysteine|aspartate|asparagine|glycine|serine|threonine|proline|histidine|lysine|arginine|glutamine", V2) ~ "Amino Acid Degradation",
      grepl("synthesis", V2, ignore.case = TRUE) & grepl("tyrosine|phenylalanine|tryptophan|glutamate|GABA|serotonin|histamine|dopamine", V2) ~ "Amino Acid or Neuroactive Synthesis",
      grepl("degradation", V2, ignore.case = TRUE) & grepl("lactose|sucrose|fructose|galactose|starch|trehalose|arabinose|xylose|mannose|rhamnose|melibiose|maltose|allose|pectin|fructan|galacturonate", V2) ~ "Sugar Degradation",
      grepl("glycolysis|pentose phosphate|Entner-Doudoroff|Bifidobacterium shunt", V2, ignore.case = TRUE) ~ "Sugar Metabolism",
      grepl("butyrate|propionate|acetate", V2, ignore.case = TRUE) ~ "SCFA Metabolism",
      grepl("menaquinone|SAM|vitamin", V2, ignore.case = TRUE) ~ "Vitamin & Cofactor Metabolism",
      grepl("serotonin|GABA|dopamine|histamine|tryptamine", V2, ignore.case = TRUE) ~ "Neuroactive Compound Metabolism",
      grepl("triacylglycerol|glycerol|fatty acid", V2, ignore.case = TRUE) ~ "Lipid Metabolism",
      grepl("nitric oxide|hydrogen|sulfate|nitrate", V2, ignore.case = TRUE) ~ "Gas Metabolism",
      grepl("methanogenesis", V2, ignore.case = TRUE) ~ "Methanogenesis",
      grepl("quinolinic acid|DOPAC|NAD", V2, ignore.case = TRUE) ~ "Nucleotide/Quinone Metabolism",
      grepl("chaperone", V2, ignore.case = TRUE) ~ "Peptide/Protein Metabolism",
      TRUE ~ "Other"
    ),
    Category_Description = case_when(
      Category == "Amino Acid Degradation" ~ "Breakdown of amino acids like tyrosine, glutamate, lysine, etc.",
      Category == "Amino Acid or Neuroactive Synthesis" ~ "Biosynthesis of amino acids and related neurotransmitters (e.g., GABA, serotonin).",
      Category == "Sugar Degradation" ~ "Catabolism of mono-, di-, and polysaccharides (e.g., lactose, pectin, trehalose).",
      Category == "Sugar Metabolism" ~ "Core sugar metabolic pathways like glycolysis and pentose phosphate pathway.",
      Category == "SCFA Metabolism" ~ "Production or degradation of short-chain fatty acids (butyrate, propionate, acetate).",
      Category == "Vitamin & Cofactor Metabolism" ~ "Biosynthesis of vitamins and cofactors like vitamin K2, SAM.",
      Category == "Neuroactive Compound Metabolism" ~ "Metabolism of compounds affecting the nervous system (e.g., GABA, dopamine).",
      Category == "Lipid Metabolism" ~ "Metabolism of lipids, glycerol, and fatty acids.",
      Category == "Gas Metabolism" ~ "Involves nitrogen, sulfur, and hydrogen compound transformations (e.g., NO, sulfate).",
      Category == "Methanogenesis" ~ "Microbial pathways producing methane from carbon or methyl sources.",
      Category == "Nucleotide/Quinone Metabolism" ~ "Metabolism of nucleotide-like or redox-active compounds (e.g., quinolinic acid).",
      Category == "Peptide/Protein Metabolism" ~ "Chaperone proteins and protein folding/degradation.",
      Category == "Other" ~ "Does not fit clearly into predefined categories.",
      TRUE ~ NA_character_
    )
  )
tax_table(GMMs_corrected) <- tax_table(as.matrix(tax_GMM))
dominant_GMM_Categoty <-dominant(GMMs_corrected, level = "Category")
sample_names2 <-sample_names(GMMs_corrected)
combined_data2 <- data.frame(sample_names = sample_names2, `Dominant_Category` = dominant_GMM_Categoty)

# Merge the data frames based on SampleID and sample_names
metadata <- merge(metadata, combined_data2, by.x = "SampleID", by.y = "sample_names", all.x = TRUE)


tax<-as.data.frame(tax_table(ARGs_ok_corrected))
tax <- tax %>%
  mutate(Class = case_when(
    str_detect(`Drug Class`, regex("aminoglycoside", ignore_case = TRUE)) ~ "Aminoglycoside",
    str_detect(`Drug Class`, regex("rifamycin", ignore_case = TRUE)) ~ "Rifamycin",
    str_detect(`Drug Class`, regex("tetracycline|minocycline|doxycycline|tigecycline", ignore_case = TRUE)) ~ "Tetracycline",
    str_detect(`Drug Class`, regex("phenicol", ignore_case = TRUE)) ~ "Amphenicol",
    str_detect(`Drug Class`, regex("beta-lactam|penam|penem|monobactam|carbapenem|cephalosporin|cephamycin", ignore_case = TRUE)) ~ "Beta-lactam",
    str_detect(`Drug Class`, regex("diaminopyrimidine|sulfonamide|sulfone|trimethoprim", ignore_case = TRUE)) ~ "Folate pathway antagonist",
    str_detect(`Drug Class`, regex("glycopeptide", ignore_case = TRUE)) ~ "Glycopeptide",
    str_detect(`Drug Class`, regex("ionophore", ignore_case = TRUE)) ~ "Ionophore",  # might not appear in your data
    str_detect(`Drug Class`, regex("lincosamide", ignore_case = TRUE)) ~ "Lincosamide",
    str_detect(`Drug Class`, regex("macrolide", ignore_case = TRUE)) ~ "Macrolide",
    str_detect(`Drug Class`, regex("pleuromutilin", ignore_case = TRUE)) ~ "Pleuromutilin",
    str_detect(`Drug Class`, regex("fluoroquinolone|quinolone", ignore_case = TRUE)) ~ "Quinolone",
    str_detect(`Drug Class`, regex("streptogramin", ignore_case = TRUE)) ~ "Streptogramin",
    str_detect(`Drug Class`, regex("nitroimidazole|nitrofuran", ignore_case = TRUE)) ~ "Nitroimidazole",
    str_detect(`Drug Class`, regex("oxazolidinone|linezolid", ignore_case = TRUE)) ~ "Oxazolidinone",  # rare in this column
    str_detect(`Drug Class`, regex("fosfomycin", ignore_case = TRUE)) ~ "Fosfomycin",
    str_detect(`Drug Class`, regex("elfamycin", ignore_case = TRUE)) ~ "Elfamycin",
    str_detect(`Drug Class`, regex("aminocoumarin", ignore_case = TRUE)) ~ "Aminocoumarin",
    str_detect(`Drug Class`, regex("acridine dye", ignore_case = TRUE)) ~ "Acridine dye",
    str_detect(`Drug Class`, regex("triclosan", ignore_case = TRUE)) ~ "Triclosan",
    str_detect(`Drug Class`, regex("benzalkonium chloride|rhodamine", ignore_case = TRUE)) ~ "Biocide",
    TRUE ~ "Unclassified"
  ))
tax$Class[is.na(tax$`Drug Class`)] <- "Unclassified"
tax$Class2 <- tax$Class
tax<-tax[,c("Class", "Class2")]
tax_table(ARGs_ok_corrected) <- tax_table(as.matrix(tax))
dominant_ARG_class <-dominant(ARGs_ok_corrected, level = "Class")
sample_names3 <-sample_names(ARGs_ok_corrected)

combined_data3 <- data.frame(sample_names = sample_names3, `Dominant_Class` = dominant_ARG_class)

# Merge the data frames based on SampleID and sample_names
metadata <- merge(metadata, combined_data3, by.x = "SampleID", by.y = "sample_names", all.x = TRUE)

```

#Sankey Diagram
```{r plot1}
library(tidyr)
metadata$DmGenderSexID <- as.factor(metadata$DmGenderSexID)
metadata$Group_cutoff_4 <- as.factor(metadata$Group_cutoff_4)
metadata$Timepoint <- as.factor(metadata$Timepoint)
metadata$Study <- as.factor(metadata$Study)


df <- metadata %>%
  ggsankey::make_long(Group_cutoff_4, Amm_ranges, Dominant_families, Dominant_Class, Age_ranges)

ggplot(df, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               label = node)) +
    geom_sankey(flow.alpha = 0.5, node.color = 1) +
    geom_sankey_label(size = 3.5, color = 1, fill = "white") +
    scale_fill_viridis_d() +
    theme_sankey(base_size = 16) +
    theme(legend.position = "none")
ggsave("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/Figures_merged/Sankey_Diagram.pdf", height = 4, width = 8)

metadata_T0 <- metadata[metadata$Timepoint == "T0", ]
df_T0 <- metadata_T0 %>%
  ggsankey::make_long(Group_cutoff_4, Amm_ranges, Dominant_families, Dominant_Class, Age_ranges)

ggplot(df_T0, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               label = node)) +
    geom_sankey(flow.alpha = 0.5, node.color = 1) +
    geom_sankey_label(size = 3.5, color = 1, fill = "white") +
    scale_fill_viridis_d() +
    theme_sankey(base_size = 16) +
    theme(legend.position = "none")
ggsave("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/Figures_merged/Sankey_Diagram_T0.pdf", height = 4, width = 8)

metadata_T2 <- metadata[metadata$Timepoint == "T2", ]
df_T2 <- metadata_T2 %>%
  ggsankey::make_long(Group_cutoff_4, Amm_ranges, Dominant_families, Dominant_Class, Age_ranges)

ggplot(df_T2, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node),
               label = node)) +
    geom_sankey(flow.alpha = 0.5, node.color = 1) +
    geom_sankey_label(size = 3.5, color = 1, fill = "white") +
    scale_fill_viridis_d() +
    theme_sankey(base_size = 16) +
    theme(legend.position = "none")
ggsave("/fast/AG_Forslund/Lola/Secuencias_INCLIVA_2024/MHE_rif/outputs/merged/Figures_merged/Sankey_Diagram_T2.pdf", height = 4, width = 8)
```
